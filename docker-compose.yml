services:
  proxy:
    depends_on:
      - collaboratorium
    environment:
      CERTBOT_EMAIL: ${CERTBOT_EMAIL:?}
      DOMAIN: ${DOMAIN:?}
      NGINX_ENVSUBST_OUTPUT_DIR: /etc/nginx/user_conf.d
      USE_LOCAL_CA: ${USE_LOCAL_CA}
    image: jonasal/nginx-certbot:6.0.1-nginx1.29.1
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    volumes:
      - ./nginx:/etc/nginx/templates
      - letsencrypt:/etc/letsencrypt

  collaboratorium:
    build: .
    pull_policy: build
    tty: true
    image: collaboratorium:latest
    ports:
      - "8050:8050"
    volumes:
      # Bind-mount the host database file into the container so data persists
      - ${APP_DATA_DIR}/database.db:/app/database.db
      - ${APP_DATA_DIR}/analytics.db:/app/analytics.db
      # Also mount config so container and host share the same config file
      - ${APP_DATA_DIR}/config.yaml:/app/config.yaml:ro
      - ${APP_DATA_DIR}/.env:/app/.env
    restart: unless-stopped

volumes:
  letsencrypt:
    driver: local
